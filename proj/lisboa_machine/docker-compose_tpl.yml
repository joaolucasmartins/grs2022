version: "3.8"
networks:
  webapp_B:
    driver: macvlan
    driver_opts:
      parent: ens19.3
    name: webapp_B
    ipam:
      config:
        - subnet: "10.0.3.0/24"
          gateway: "10.0.3.254"
  internal_B:
    driver: macvlan
    driver_opts:
      parent: ens19.2
    name: internal_B
    ipam:
      config:
        - subnet: "10.0.2.0/24"
          gateway: "10.0.2.254"
  dmz_B:
    driver: macvlan
    driver_opts:
      parent: ens19.1
    name: dmz_B
    ipam:
      config:
        - subnet: "10.0.1.0/24"
          gateway: "10.0.1.254"
  pubnet:
    name: pubnet
    ipam:
      config:
        - subnet: "172.31.255.0/24"
          gateway: "172.31.255.254"
  internet:
    driver: macvlan
    driver_opts:
      parent: ens20
    name: internet
    ipam:
      config:
        - subnet: "172.31.50.0/24"
          gateway: "172.31.50.254"

services:
  # PUBLIC NET
  er_b:
    build: ./edge_router
    container_name: er_b
    sysctls:
      - net.ipv4.ip_forward=1
    cap_add:
      - NET_ADMIN
    entrypoint: er_b_entrypoint
    networks:
      dmz_B:
        ipv4_address: er_b_dmz_b
      pubnet:
        ipv4_address: er_b_pubnet
      internet:
        ipv4_address: er_b_internet
  external_host_b:
    build: ./router
    container_name: external_host_b
    cap_add:
      - NET_ADMIN
    networks:
      pubnet:
        ipv4_address: external_host_b_pubnet
    command: ["172.31.255.253"]

  # DMZ
  ## ROUTERS
  r_b:
    build: ./router
    container_name: r_b
    sysctls:
      - net.ipv4.ip_forward=1
    cap_add:
      - NET_ADMIN
    networks:
      internal_B:
        ipv4_address: r_b_internal_b
      dmz_B:
        ipv4_address: r_b_dmz_b
    command: ["10.0.1.0/24", "10.0.1.3"]
  firewall:
    build: ./firewall
    container_name: firewall
    cap_add:
      - NET_ADMIN
    entrypoint: firewall_entrypoint
    networks:
      dmz_B:
        ipv4_address: firewall_dmz_B
  ## VPN - https://github.com/linuxserver/docker-wireguard
  wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: wireguard
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Lisbon
      - SERVERPORT=51820
      - PEERS=10
      - PEERDNS=auto
      - INTERNAL_SUBNET=10.0.1.0
      - ALLOWEDIPS=0.0.0.0/0
      - LOG_CONFS=true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - wireguard_config:/config
      - /lib/modules:/lib/modules
    ports:
      - 51820:51820/udp
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    restart: unless-stopped
  ## WEBAPP (deals with webapp net)
  webapp_worker1:
    build: ./webapp_worker
    container_name: webapp_worker1
    networks:
      webapp_B:
        ipv4_address: webapp_worker1_webapp_b
  webapp_worker2:
    build: ./webapp_worker
    container_name: webapp_worker2
    networks:
      webapp_B:
        ipv4_address: webapp_worker2_webapp_b
  webapp:
    build: ./webapp
    container_name: webapp
    cap_add:
      - NET_ADMIN
    networks:
      webapp_B:
        ipv4_address: webapp_webapp_b
      dmz_B:
        ipv4_address: webapp_dmz_b
    command: ["10.0.1.0/24","10.0.1.3"]

  # INTERNAL
  dhcp_b:
    build: ./dhcp
    container_name: dhcp_b
    networks:
      internal_B:
        ipv4_address: dhcp_b_internal_b
    command: ["10.0.2.", "1.1.1.1"]
  ## DB
  postgres:
    image: postgres:14
    container_name: postgres_container
    restart: unless-stopped
    environment:
      POSTGRES_DB: postgres_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      internal_B:
        ipv4_address: postgres_internal_b
  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_container
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: secret
      PGADMIN_LISTEN_PORT: 80
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      internal_B:
        ipv4_address: pgadmin_internal_b
  ## EMPLOYEES
  webdev1:
    build: ./webdev
    container_name: webdev1
    cap_add:
      - NET_ADMIN
    networks:
      internal_B:
        ipv4_address: webdev1_internal_b
  webdev2:
    build: ./webdev
    container_name: webdev2
    cap_add:
      - NET_ADMIN
    networks:
      internal_B:
        ipv4_address: webdev2_internal_b

volumes:
  db-data:
  pgadmin-data:
  wireguard_config:
